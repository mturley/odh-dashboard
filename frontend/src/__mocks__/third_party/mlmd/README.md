# Third-Party Generated Protobuf Code for MLMD mocks

The code in this directory is equivalent to the code in `frontend/src/third_party/mlmd`, but was generated with [a different tool called ts-proto](https://www.npmjs.com/package/ts-proto). This generated code is used for serializing and deserializing [gRPC](https://grpc.io) message objects, which are defined by [Protobuf .proto schema files](https://protobuf.dev/programming-guides/proto2/).

The code used in production (in `frontend/src/third_party/mlmd`) was copied [directly from Kubeflow here](https://github.com/kubeflow/pipelines/blob/master/frontend/src/third_party/mlmd/index.ts) in [odh-dashboard PR #2613](https://github.com/opendatahub-io/odh-dashboard/pull/2613), and was generated by [protobuf.js](https://github.com/protobufjs/protobuf.js). We initially tried to reuse that code for mocking these objects in Cypress tests, but that implementation does not provide an easy way to serialize them from JSON which makes mocking inconvenient.

We found alternate protobuf client generators which include extra features such as a `.fromJSON` method which makes it easier to provide mock data for tests. We chose [ts-proto](<(https://www.npmjs.com/package/ts-proto)>) and generated this alternate version of the code with it, which is currently **_only to be used for serializing mock data in tests and NOT for use in production_**. While the two are compatible in theory, this avoids the risk associated with replacing production code that currently is guaranteed to exactly match the upstream Kubeflow frontend.

Note: MLMD is still using protobuf.js in the upstream Kubeflow repo, but there are other places in Kubeflow that have transitioned from protobuf.js to ts-proto (see [kubeflow/pipelines PR #7125](https://github.com/kubeflow/pipelines/pull/7125)), so we may end up replacing the production code with ts-proto code in the future.

## How this code was generated

1. Installed the [protobuf runtime](https://github.com/protocolbuffers/protobuf) on Mac with `brew install protobuf`

2. In a new temporary directory: cloned the [google/ml-metadata repo](https://github.com/google/ml-metadata), installed [ts-proto](https://www.npmjs.com/package/ts-proto) from npm, created an empty `generated` directory, and ran the protoc command using ts-proto as a plugin and the `metadata_store_service.proto` file from the ml-metadata repo

   ```sh
   mkdir ~/tmp/mlmd
   cd ~/tmp/mlmd
   git clone git@github.com:google/ml-metadata.git
   npm install ts-proto
   mkdir generated
   protoc --plugin=./node_modules/.bin/protoc-gen-ts_proto -I=./ml-metadata --ts_proto_out=./generated --ts_proto_opt=esModuleInterop=true --ts_proto_opt=env=browser ./ml-metadata/ml_metadata/proto/metadata_store_service.proto
   ```

3. Copied the contents of the `generated` directory

---

TODO: (and look at compareRuns.cy.ts for other TODO mess)

- Give up on the JSON format we see in the browser extension - customPropertiesMap etc
- Try mocking some artifacts using `fromJSON` with the stuff we got from ts-proto
  -- see if it works via cypress and actually mocks what the client expects
- If not ---- abandon the fromJSON idea I guess? Was going to continue exploring to see if there's a way to get a fromObject compiled with the regular protobuf-js builder that was used for production
- Maybe try protobufjs at run time.... https://github.com/protobufjs/protobuf.js/blob/master/README.md#using-proto-files
- Check the kubeflow version used by odh, and the mlmd version used by that, maybe this schema difference is from a different proto file.... or, try generating the JS the way it's done in
